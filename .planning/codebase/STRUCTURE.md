# Codebase Structure

**Analysis Date:** 2026-03-02

## Directory Layout

```
ShadowDrive-AI/
├── app/                    # Next.js app router (pages + API routes)
├── components/             # React UI components
├── lib/                    # Core logic: speech engine, generation, data access
├── types/                  # TypeScript type definitions
├── public/                 # Static assets (icons, service worker)
├── prisma/                 # Database schema and migrations
├── __tests__/              # Test files (vitest)
├── backend/                # Future Express backend (Phase 8, not active)
├── mobile/                 # Future React Native app (Phase 8+, not active)
├── packages/shared/        # Future shared types/constants (not integrated)
├── scripts/                # Build/seed scripts
├── auth.ts                 # NextAuth v5 configuration
├── next.config.js          # Next.js config (standalone output)
├── tailwind.config.ts      # TailwindCSS theme
├── tsconfig.json           # TypeScript config (excludes backend, mobile, packages)
├── package.json            # Root dependencies
├── vitest.config.ts        # Test runner config
└── prisma/schema.prisma    # Prisma data model
```

## Directory Purposes

**`app/`:**
- Purpose: Next.js App Router — pages, layouts, API routes
- Contains: Page components (page.tsx), API handlers (route.ts), layouts
- Key files:
  - `app/page.tsx` — Root page (auth check → redirect/landing)
  - `app/layout.tsx` — Root layout (metadata, PWA setup, theme provider)
  - `app/dashboard/page.tsx` — Main dashboard (client component, three tabs)
  - `app/providers.tsx` — SessionProvider wrapper
  - `app/api/generate/route.ts` — POST to generate AI scenarios
  - `app/api/progress/route.ts` — GET/POST lesson progress
  - `app/api/courses/route.ts` — GET courses + lessons
  - `app/api/ai-lessons/route.ts`, `app/api/custom-lessons/route.ts` — CRUD saved lessons

**`components/`:**
- Purpose: Reusable React UI components
- Contains: Presentational and container components
- Key files:
  - `AudioPlayer.tsx` — Playback controller (play/pause/stop buttons, status display)
  - `ScenarioForm.tsx` — AI lesson generation form (topic + difficulty input)
  - `CustomTextForm.tsx` — Custom lesson form (manual text input)
  - `LessonPreview.tsx` — Read-only lesson display (title, content preview)
  - `SavedLessonCard.tsx` — Saved lesson card UI (delete, resume options)
  - `LandingPage.tsx` — Landing page for unauthenticated users
  - `AuthModal.tsx` — Login/signup modal (email, password, Google)
  - `AuthButton.tsx` — Login/logout button
  - `Toast.tsx` — Toast notification provider and hook
  - `ConfirmModal.tsx` — Confirmation dialog (delete warnings)
  - `ResumePromptModal.tsx` — Resume vs restart prompt
  - `ThemeToggle.tsx` — Dark/light theme switcher
  - `StatusBar.tsx` — Playback progress bar and current phase display
  - `GeneratingLoader.tsx` — Loading spinner during generation

**`lib/`:**
- Purpose: Core logic, utilities, data access (framework-independent where possible)
- Contains: Pure functions, API clients, persistence utilities
- Key files:
  - `speechEngine.ts` — Web Speech API wrapper (speakAsync, playScenario generator)
  - `resumablePlayback.ts` — Resume position abstraction (getResumableId, storage functions)
  - `voiceSelector.ts` — Voice selection and speech rate by CEFR level
  - `gemini.ts` — Google Generative AI client with model fallback chain
  - `openrouter.ts` — OpenRouter API client (Qwen3 priority)
  - `offlineScenarios.ts` — Fallback offline scenario library (when LLM unavailable)
  - `api.ts` — HTTP client for future backend integration (token management, fetch wrapper)
  - `prisma.ts` — Prisma client singleton (null if DATABASE_URL not set)
  - `scenarioCache.ts` — sessionStorage cache for generated scenarios
  - `theme.tsx` — Dark/light theme context and provider
  - `globals.css` — TailwindCSS directives and custom styles

**`types/`:**
- Purpose: Shared TypeScript definitions
- Contains: Interface definitions, type aliases
- Key files:
  - `dialogue.ts` — DialogueLine, Scenario, PlaybackStatus, PlaybackPhase, CEFRLevel, GenerateRequest
  - `next-auth.d.ts` — NextAuth session type augmentation

**`prisma/`:**
- Purpose: Database schema and migrations
- Contains: Prisma schema, migration files
- Key files:
  - `schema.prisma` — Data model (User, Account, Session, Progress, GeneratedScenario, CustomLesson, Course, Lesson, etc.)
  - `migrations/` — SQL migration history (auto-generated by `prisma migrate`)
  - `seed.ts` — Database seeding script (populates initial courses/lessons)

**`public/`:**
- Purpose: Static assets served at root (`/`)
- Contains: PWA icons, manifest, service worker
- Key files:
  - `manifest.json` — PWA manifest (app name, icons, start URL)
  - `sw.js` — Service worker (offline caching, background sync)
  - `icons/` — Icon files (192x192, 512x512, favicon)

**`__tests__/`:**
- Purpose: Test files (vitest)
- Contains: Unit and integration tests
- Organization:
  - `__tests__/lib/` — Tests for speechEngine, scenarioCache, resumablePlayback
  - `__tests__/components/` — Component tests
  - `__tests__/api/` — API route tests

**`auth.ts`:**
- Purpose: NextAuth v5 configuration (not in app/ directory due to import requirements)
- Contains: Providers (Google, Credentials), callbacks, session strategy
- Used by: `app/providers.tsx`, API routes

**`scripts/`:**
- Purpose: Build and utility scripts
- Contains: Database seed script, import utilities

## Key File Locations

**Entry Points:**
- `app/page.tsx` — Root page, auth redirect logic
- `app/layout.tsx` — Root layout, service worker registration
- `app/dashboard/page.tsx` — Main dashboard, core app
- `auth.ts` — NextAuth configuration

**Configuration:**
- `tsconfig.json` — TypeScript compiler options (excludes backend, mobile, packages)
- `next.config.js` — Next.js settings (standalone output for Docker)
- `tailwind.config.ts` — TailwindCSS theme customization
- `package.json` — Dependencies and scripts
- `vitest.config.ts` — Test runner configuration
- `.env.local` — Local environment variables (GEMINI_API_KEY, DATABASE_URL, etc.)

**Core Logic:**
- `lib/speechEngine.ts` — 6-phase playback loop (Target → Pause → Native → Gap → Repeat → Pause)
- `lib/gemini.ts` — LLM API calls with fallback chain
- `lib/resumablePlayback.ts` — Resume position storage (localStorage + database)
- `lib/scenarioCache.ts` — Session storage cache for scenarios

**Data Access:**
- `prisma/schema.prisma` — Database schema
- `lib/prisma.ts` — Prisma client singleton
- `auth.ts` — Session/auth configuration
- `app/api/progress/route.ts` — Progress persistence
- `app/api/courses/route.ts` — Course data access

**Testing:**
- `__tests__/lib/speechEngine.test.ts` — Speech engine unit tests
- `__tests__/lib/scenarioCache.test.ts` — Cache behavior tests
- `__tests__/lib/resumablePlayback.test.ts` — Resume logic tests

## Naming Conventions

**Files:**
- Page components: `[feature]/page.tsx` (e.g., `dashboard/page.tsx`)
- API routes: `api/[feature]/route.ts` (e.g., `api/generate/route.ts`)
- Components: PascalCase (e.g., `AudioPlayer.tsx`, `ScenarioForm.tsx`)
- Utilities: camelCase (e.g., `speechEngine.ts`, `voiceSelector.ts`)
- Tests: `[file].test.ts` or `[file].spec.ts` (e.g., `speechEngine.test.ts`)
- Types: Named exports in `types/` directory (e.g., `types/dialogue.ts`)

**Directories:**
- Feature directories in `app/`: kebab-case (e.g., `app/api`, `app/dashboard`)
- Component directories: PascalCase (not used; all components flat in `components/`)
- Utility directories: camelCase (e.g., `lib/`, `types/`)

**Functions:**
- Async functions: camelCase (e.g., `speakAsync`, `generateWithFallback`)
- Generators: camelCase with "play" or "generate" prefix (e.g., `playScenario`)
- Hooks: `use` prefix for React hooks (e.g., `useToast`, `useSession`)
- Getters: `get` prefix (e.g., `getResumableId`, `getBestVoice`, `getGeminiClient`)

**Variables:**
- React state: camelCase (e.g., `isPlaying`, `currentStatus`)
- Constants: UPPERCASE (e.g., `STORAGE_PREFIX`, `MODEL_CANDIDATES`)
- Types: PascalCase (e.g., `Scenario`, `PlaybackStatus`, `CEFRLevel`)

## Where to Add New Code

**New Feature:**
- Page component: Create `app/[feature]/page.tsx`
- API route: Create `app/api/[feature]/route.ts`
- Shared utilities: Add to `lib/[feature].ts`
- Test: Create `__tests__/[feature].test.ts`

**Example: Adding a "Stats" page**
```
app/stats/page.tsx          # Page component
app/api/stats/route.ts      # GET endpoint for stats data
lib/stats.ts                # Utility functions (aggregations, etc.)
__tests__/stats.test.ts     # Tests
components/StatsCard.tsx    # Reusable stats component
```

**New Component:**
- File location: `components/[ComponentName].tsx`
- Type: Decide if client (`'use client'`) or server component
- Props interface: Define above component: `interface [ComponentName]Props { ... }`
- Export: Default export, named export for testing

**Example: Adding "ProgressChart.tsx"**
```typescript
'use client';

interface ProgressChartProps {
  data: ProgressRecord[];
}

export default function ProgressChart({ data }: ProgressChartProps) {
  // Implementation
}
```

**New Utility Function:**
- File location: `lib/[feature].ts`
- Pattern: Pure functions, no side effects (avoid console logs in production)
- Exports: Named exports for testability
- Types: Import from `types/`

**Example: Adding "lessonHelper.ts"**
```typescript
import type { Scenario } from '@/types/dialogue';

export function calculateTotalTime(scenario: Scenario): number {
  // Implementation
}

export function sortByDifficulty(scenarios: Scenario[]): Scenario[] {
  // Implementation
}
```

**New Database Model:**
- Modify: `prisma/schema.prisma`
- Create migration: `npx prisma migrate dev --name [migration_name]`
- Generate client: `npx prisma generate` (auto on postinstall)
- Update types: If model is part of API response, update `types/`
- Update seed: If model needs initial data, modify `prisma/seed.ts`

## Special Directories

**`.next/`:**
- Purpose: Next.js build output (generated)
- Generated: Yes
- Committed: No (in .gitignore)

**`node_modules/`:**
- Purpose: Installed npm packages
- Generated: Yes
- Committed: No

**`prisma/migrations/`:**
- Purpose: SQL migration files (auto-generated by `prisma migrate`)
- Generated: Yes (by Prisma CLI)
- Committed: Yes (tracked for reproducibility)

**`__tests__/`:**
- Purpose: Test files (vitest)
- Generated: No
- Committed: Yes

**`backend/` and `mobile/`:**
- Purpose: Future (Phase 8) — separate Express backend and React Native app
- Generated: No
- Committed: Yes (but excluded from tsconfig.json, not built with Next.js)

**`packages/shared/`:**
- Purpose: Future (Phase 8) — shared types between frontend/backend/mobile
- Generated: No
- Committed: Yes (but not integrated yet)

---

*Structure analysis: 2026-03-02*
